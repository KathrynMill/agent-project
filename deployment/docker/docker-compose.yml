version: '3.8'

services:
  # API服务
  api:
    build:
      context: ../../
      dockerfile: deployment/docker/Dockerfile.api
    container_name: script-compression-api
    ports:
      - "9000:9000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=9000
      - LOG_LEVEL=INFO
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - NEBULA_HOST=nebula-graphd
      - NEBULA_PORT=9669
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
    depends_on:
      - nebula-metad
      - nebula-graphd
      - nebula-storaged
      - qdrant
    volumes:
      - ../../logs:/app/logs
      - ../../data:/app/data
    restart: unless-stopped
    networks:
      - script-compression

  # NebulaGraph Meta服务
  nebula-metad:
    image: vesoft/nebula-graph:v3.5.0
    container_name: nebula-metad
    environment:
      - USER=root
      - TZ=UTC
    command:
      - --meta_server_addrs=nebula-metad:9559
      - --local_ip=nebula-metad
      - --ws_ip=nebula-metad
      - --port=9559
      - --data_path=/data/meta
      - --log_dir=/logs
      - --v=0
      - --minloglevel=0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://nebula-metad:19559/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    ports:
      - "9559:9559"
      - "19559:19559"
    volumes:
      - ./nebula-data/meta:/data/meta
      - ./nebula-logs/meta:/logs
    networks:
      - script-compression
    restart: unless-stopped

  # NebulaGraph Graph服务
  nebula-graphd:
    image: vesoft/nebula-graph:v3.5.0
    container_name: nebula-graphd
    environment:
      - USER=root
      - TZ=UTC
    command:
      - --meta_server_addrs=nebula-metad:9559
      - --local_ip=nebula-graphd
      - --ws_ip=nebula-graphd
      - --port=9669
      - --data_path=/data/graph
      - --log_dir=/logs
      - --v=0
      - --minloglevel=0
    depends_on:
      nebula-metad:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://nebula-graphd:19669/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    ports:
      - "9669:9669"
      - "19669:19669"
    volumes:
      - ./nebula-data/graph:/data/graph
      - ./nebula-logs/graph:/logs
    networks:
      - script-compression
    restart: unless-stopped

  # NebulaGraph Storage服务
  nebula-storaged:
    image: vesoft/nebula-graph:v3.5.0
    container_name: nebula-storaged
    environment:
      - USER=root
      - TZ=UTC
    command:
      - --meta_server_addrs=nebula-metad:9559
      - --local_ip=nebula-storaged
      - --ws_ip=nebula-storaged
      - --port=9779
      - --data_path=/data/storage
      - --log_dir=/logs
      - --v=0
      - --minloglevel=0
    depends_on:
      nebula-metad:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://nebula-storaged:19779/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    ports:
      - "9779:9779"
      - "19779:19779"
    volumes:
      - ./nebula-data/storage:/data/storage
      - ./nebula-logs/storage:/logs
    networks:
      - script-compression
    restart: unless-stopped

  # Qdrant向量数据库
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    volumes:
      - ./qdrant-data:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - script-compression
    restart: unless-stopped

  # Redis缓存（可选）
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - ./redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - script-compression
    restart: unless-stopped

  # Nginx反向代理
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - api
    networks:
      - script-compression
    restart: unless-stopped

networks:
  script-compression:
    driver: bridge

volumes:
  nebula-data:
    driver: local
  nebula-logs:
    driver: local
  qdrant-data:
    driver: local
  redis-data:
    driver: local