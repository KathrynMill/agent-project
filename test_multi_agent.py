#!/usr/bin/env python3
"""
å¤šæ™ºèƒ½é«”ç³»çµ±æ¸¬è©¦è…³æœ¬
æ¸¬è©¦åŠ‡æœ¬å£“ç¸®çš„å¤šæ™ºèƒ½é«”å·¥ä½œæµç¨‹
"""

import requests
import json
import time

# API åŸºç¤ URL
BASE_URL = "http://localhost:9000"

def test_health():
    """æ¸¬è©¦å¥åº·æª¢æŸ¥"""
    print("ğŸ” æ¸¬è©¦å¥åº·æª¢æŸ¥...")
    try:
        response = requests.get(f"{BASE_URL}/health")
        if response.status_code == 200:
            print("âœ… å¥åº·æª¢æŸ¥é€šé")
            return True
        else:
            print(f"âŒ å¥åº·æª¢æŸ¥å¤±æ•—: {response.status_code}")
            return False
    except Exception as e:
        print(f"âŒ å¥åº·æª¢æŸ¥ç•°å¸¸: {str(e)}")
        return False

def test_compress_script():
    """æ¸¬è©¦åŠ‡æœ¬å£“ç¸®åŠŸèƒ½"""
    print("\nğŸ­ æ¸¬è©¦åŠ‡æœ¬å£“ç¸®åŠŸèƒ½...")
    
    # æº–å‚™æ¸¬è©¦æ•¸æ“š
    test_data = {
        "player_scripts": {
            "ç‹å»ºåœ‹": """
            æˆ‘æ˜¯ç‹å»ºåœ‹ï¼Œæˆ¿åœ°ç”¢å¤§äº¨ã€‚ä»Šæ™šæ˜¯æˆ‘çš„ç”Ÿæ—¥æ™šå®´ï¼Œé‚€è«‹äº†å¹¾å€‹æœ‹å‹ã€‚
            æˆ‘å’Œå¦»å­æç¾éº—æœ€è¿‘é—œä¿‚ä¸å¤ªå¥½ï¼Œå¥¹ç¸½æ˜¯æ‡·ç–‘æˆ‘åœ¨å¤–é¢æœ‰å¥³äººã€‚
            å…¶å¯¦æˆ‘ç¢ºå¯¦å’ŒåŠ‰ç§˜æ›¸æœ‰é—œä¿‚ï¼Œè€Œä¸”å¥¹æ‡·äº†æˆ‘çš„å­©å­ã€‚
            æˆ‘æº–å‚™ä¿®æ”¹éºå›‘ï¼ŒæŠŠå¤§éƒ¨åˆ†è²¡ç”¢ç•™çµ¦åŠ‰ç§˜æ›¸ã€‚
            """,
            "æç¾éº—": """
            æˆ‘æ˜¯æç¾éº—ï¼Œç‹å»ºåœ‹çš„å¦»å­ã€‚æˆ‘çŸ¥é“ä»–åœ¨å¤–é¢æœ‰å¥³äººï¼Œä½†æˆ‘é¸æ“‡éš±å¿ã€‚
            ä»Šæ™šçš„æ™šå®´ä¸Šï¼Œæˆ‘å’Œä»–å› ç‚ºè²¡ç”¢åˆ†é…å•é¡Œç™¼ç”Ÿäº†æ¿€çƒˆçˆ­åµã€‚
            æˆ‘ç™¼ç¾ä»–æº–å‚™æŠŠè²¡ç”¢ç•™çµ¦åˆ¥çš„å¥³äººï¼Œé€™è®“æˆ‘éå¸¸æ†¤æ€’ã€‚
            æˆ‘åˆ©ç”¨ä»–çš„å¿ƒè‡Ÿç—…ï¼Œåœ¨çˆ­åµä¸­æ•…æ„åˆºæ¿€ä»–ã€‚
            """,
            "å¼µå¾‹å¸«": """
            æˆ‘æ˜¯å¼µå¾‹å¸«ï¼Œç‹å»ºåœ‹çš„æ³•å¾‹é¡§å•ã€‚æˆ‘çŸ¥é“ä»–æº–å‚™ä¿®æ”¹éºå›‘ã€‚
            ä»Šæ™šçš„æ™šå®´ä¸Šï¼Œæˆ‘è©¦åœ–å‹¸è§£ç‹å»ºåœ‹å’Œæç¾éº—çš„çˆ­åµã€‚
            æˆ‘çœ‹åˆ°äº†ç‹å»ºåœ‹çš„éºå›‘è‰ç¨¿ï¼Œä»–æº–å‚™æŠŠå¤§éƒ¨åˆ†è²¡ç”¢ç•™çµ¦åŠ‰ç§˜æ›¸ã€‚
            é€™è®“æˆ‘æ„Ÿåˆ°éœ‡é©šï¼Œå› ç‚ºé€™æœƒå½±éŸ¿åˆ°æç¾éº—çš„åˆ©ç›Šã€‚
            """,
            "é™³é†«ç”Ÿ": """
            æˆ‘æ˜¯é™³é†«ç”Ÿï¼Œç‹å»ºåœ‹çš„ç§äººé†«ç”Ÿã€‚æˆ‘çŸ¥é“ä»–æœ‰å¿ƒè‡Ÿç—…ï¼Œä½†æ²’æœ‰å‘Šè¨´å…¶ä»–äººã€‚
            ä»Šæ™šçš„æ™šå®´ä¸Šï¼Œæˆ‘å»æ´—æ‰‹é–“æ™‚ç™¼ç¾ç‹å»ºåœ‹å€’åœ¨æ›¸æˆ¿çš„åœ°æ¿ä¸Šã€‚
            æˆ‘ç«‹å³æª¢æŸ¥ï¼Œç™¼ç¾ä»–å·²ç¶“æ­»äº¡ï¼Œèƒ¸å£æ’è‘—ä¸€æŠŠæ°´æœåˆ€ã€‚
            æˆ‘æ³¨æ„åˆ°ä»–æ‰‹ä¸­æ¡è‘—ä¸€å¼µå¯«è‘—"èƒŒå›è€…"çš„ç´™æ¢ã€‚
            """,
            "åŠ‰ç§˜æ›¸": """
            æˆ‘æ˜¯åŠ‰ç§˜æ›¸ï¼Œç‹å»ºåœ‹çš„ç§˜æ›¸ã€‚æˆ‘å€‘æœ‰ç§˜å¯†é—œä¿‚ï¼Œæˆ‘æ‡·äº†ä»–çš„å­©å­ã€‚
            ä»Šæ™šçš„æ™šå®´ä¸Šï¼Œæˆ‘çš„æ‰‹æ©Ÿåœ¨æ›¸æˆ¿å…§ï¼Œæœ€å¾Œé€šè©±æ˜¯æ™šä¸Š8é»45åˆ†ã€‚
            æˆ‘çŸ¥é“ç‹å»ºåœ‹æº–å‚™ä¿®æ”¹éºå›‘ï¼ŒæŠŠè²¡ç”¢ç•™çµ¦æˆ‘ã€‚
            é€™è®“æˆ‘æ—¢èˆˆå¥®åˆæ“”å¿ƒï¼Œå› ç‚ºé€™æœƒå¼•èµ·å¾ˆå¤šäººçš„ä¸æ»¿ã€‚
            """
        },
        "master_guide": """
        é€™æ˜¯ä¸€å€‹å¯†å®¤æ®ºäººæ¡ˆã€‚ç‹å»ºåœ‹åœ¨æ›¸æˆ¿è¢«ç™¼ç¾æ­»äº¡ï¼Œæ›¸æˆ¿é–€å¾å…§éƒ¨é–ä½ã€‚
        é—œéµç·šç´¢ï¼š
        1. ç‹å»ºåœ‹æ‰‹ä¸­æ¡è‘—"èƒŒå›è€…"ç´™æ¢
        2. æ›¸æˆ¿å…§ç™¼ç¾æç¾éº—çš„ç™¼å¤¾
        3. å¼µå¾‹å¸«çš„å…¬æ–‡åŒ…åœ¨æ›¸æˆ¿é–€å£
        4. é™³é†«ç”Ÿçš„è½è¨ºå™¨åœ¨æ›¸æˆ¿å…§
        5. åŠ‰ç§˜æ›¸çš„æ‰‹æ©Ÿåœ¨æ›¸æˆ¿å…§
        
        çœŸç›¸ï¼šæç¾éº—æ˜¯å‡¶æ‰‹ã€‚å¥¹åˆ©ç”¨ç‹å»ºåœ‹çš„å¿ƒè‡Ÿç—…ï¼Œåœ¨çˆ­åµä¸­æ•…æ„åˆºæ¿€ä»–ï¼Œ
        å°è‡´ä»–å¿ƒè‡Ÿç—…ç™¼ä½œæ­»äº¡ã€‚ç„¶å¾Œå¥¹é€²å…¥æ›¸æˆ¿ï¼Œç”¨æ°´æœåˆ€åˆºå‘å·²ç¶“æ­»äº¡çš„ç‹å»ºåœ‹ï¼Œ
        è£½é€ ä»–æ®ºçš„å‡è±¡ï¼Œä¸¦ç•™ä¸‹"èƒŒå›è€…"ç´™æ¢æš—ç¤ºæ˜¯åŠ‰ç§˜æ›¸æ‰€ç‚ºã€‚
        """,
        "target_hours": 2
    }
    
    try:
        print("ğŸ“¤ ç™¼é€å£“ç¸®è«‹æ±‚...")
        response = requests.post(
            f"{BASE_URL}/compress_script",
            json=test_data,
            headers={"Content-Type": "application/json"}
        )
        
        if response.status_code == 200:
            result = response.json()
            print("âœ… åŠ‡æœ¬å£“ç¸®æˆåŠŸ")
            
            # é¡¯ç¤ºçµæœæ‘˜è¦
            print("\nğŸ“Š å£“ç¸®çµæœæ‘˜è¦:")
            if "compression_result" in result:
                compression_result = result["compression_result"]
                
                # é¡¯ç¤ºå£“ç¸®å¾Œçš„åŠ‡æœ¬
                if "compressed_script" in compression_result:
                    print(f"\nğŸ“ å£“ç¸®å¾Œçš„åŠ‡æœ¬:")
                    print("-" * 50)
                    print(compression_result["compressed_script"])
                    print("-" * 50)
                
                # é¡¯ç¤ºå£“ç¸®æ¯”ä¾‹
                if "compression_ratio" in compression_result:
                    print(f"\nğŸ“ˆ å£“ç¸®æ¯”ä¾‹: {compression_result['compression_ratio']:.1%}")
                
                # é¡¯ç¤ºé©—è­‰çµæœ
                if "validation_summary" in compression_result:
                    validation = compression_result["validation_summary"]
                    print(f"\nâœ… é©—è­‰çµæœ:")
                    print(f"   ç¸½é«”åˆ†æ•¸: {validation.get('overall_score', 'N/A')}")
                    print(f"   é©—è­‰ç‹€æ…‹: {validation.get('validation_status', 'N/A')}")
                    if validation.get('critical_issues'):
                        print(f"   é—œéµå•é¡Œ: {', '.join(validation['critical_issues'])}")
                
                # é¡¯ç¤ºæ™ºèƒ½é«”å·¥ä½œæµç¨‹
                if "agent_workflow" in compression_result:
                    workflow = compression_result["agent_workflow"]
                    print(f"\nğŸ¤– æ™ºèƒ½é«”å·¥ä½œæµç¨‹:")
                    if "analysis_result" in workflow:
                        print("   âœ… åˆ†ææ™ºèƒ½é«”å®Œæˆ")
                    if "compression_strategy" in workflow:
                        print("   âœ… ç­–ç•¥åˆ¶å®šå®Œæˆ")
                    if "debate_result" in workflow:
                        print("   âœ… æ™ºèƒ½é«”è¾¯è«–å®Œæˆ")
                    if "validation_result" in workflow:
                        print("   âœ… æ ¡é©—æ™ºèƒ½é«”å®Œæˆ")
            
            return True
        else:
            print(f"âŒ åŠ‡æœ¬å£“ç¸®å¤±æ•—: {response.status_code}")
            print(f"éŒ¯èª¤è©³æƒ…: {response.text}")
            return False
            
    except Exception as e:
        print(f"âŒ åŠ‡æœ¬å£“ç¸®ç•°å¸¸: {str(e)}")
        return False

def test_individual_agents():
    """æ¸¬è©¦å€‹åˆ¥æ™ºèƒ½é«”åŠŸèƒ½"""
    print("\nğŸ¤– æ¸¬è©¦å€‹åˆ¥æ™ºèƒ½é«”åŠŸèƒ½...")
    
    # é€™è£¡å¯ä»¥æ·»åŠ å°å€‹åˆ¥æ™ºèƒ½é«”çš„æ¸¬è©¦
    # ä¾‹å¦‚ç›´æ¥èª¿ç”¨ AnalysisAgentã€LogicAgent ç­‰
    print("â„¹ï¸  å€‹åˆ¥æ™ºèƒ½é«”æ¸¬è©¦éœ€è¦ç›´æ¥èª¿ç”¨ï¼Œæš«æ™‚è·³é")

def main():
    """ä¸»æ¸¬è©¦å‡½æ•¸"""
    print("ğŸš€ é–‹å§‹å¤šæ™ºèƒ½é«”ç³»çµ±æ¸¬è©¦")
    print("=" * 60)
    
    # æ¸¬è©¦å¥åº·æª¢æŸ¥
    if not test_health():
        print("âŒ å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œåœæ­¢æ¸¬è©¦")
        return
    
    # ç­‰å¾…æœå‹™å®Œå…¨å•Ÿå‹•
    print("\nâ³ ç­‰å¾…æœå‹™å®Œå…¨å•Ÿå‹•...")
    time.sleep(5)
    
    # æ¸¬è©¦åŠ‡æœ¬å£“ç¸®
    if test_compress_script():
        print("\nğŸ‰ å¤šæ™ºèƒ½é«”ç³»çµ±æ¸¬è©¦å®Œæˆï¼")
    else:
        print("\nâŒ å¤šæ™ºèƒ½é«”ç³»çµ±æ¸¬è©¦å¤±æ•—")
    
    print("\n" + "=" * 60)
    print("æ¸¬è©¦å®Œæˆ")

if __name__ == "__main__":
    main()
