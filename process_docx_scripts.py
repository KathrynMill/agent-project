#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
处理DOCX格式的剧本和手册文件
将多个文档内容合并为单个文本文件
使用python-docx库确保正确的中文编码处理
"""

import os
import sys
import re
import datetime

# 配置目录路径 - 同时处理多个剧本目录
INPUT_DIRS = [
    r"c:\Users\11928\Desktop\linshi\如是我观 - 副本\如是我观 - 副本",
    r"c:\Users\11928\Desktop\linshi\因火成烟 - 副本\因火成烟 - 副本"
]
OUTPUT_DIR = "output"
SCRIPTS_OUTPUT_FILE_PREFIX = "merged_scripts_"
MANUALS_OUTPUT_FILE_PREFIX = "merged_manuals_"

# 确保输出目录存在
def ensure_output_dir():
    """确保输出目录存在"""
    output_path = os.path.join(os.getcwd(), OUTPUT_DIR)
    if not os.path.exists(output_path):
        os.makedirs(output_path)
        print(f"✅ 创建输出目录: {output_path}")
    return output_path

# 安装必要的包
def install_required_packages():
    """安装必要的Python包"""
    try:
        # 首先尝试导入，如果失败则安装
        try:
            import docx
            print("✅ python-docx 已安装")
        except ImportError:
            print("⚠️ python-docx 未安装，正在安装...")
            import subprocess
            subprocess.check_call([sys.executable, "-m", "pip", "install", "python-docx"])
            print("✅ 成功安装 python-docx")
        
        # 尝试docx2txt作为备选
        try:
            import docx2txt
            print("✅ docx2txt 已安装")
        except ImportError:
            print("⚠️ docx2txt 未安装，正在安装...")
            import subprocess
            subprocess.check_call([sys.executable, "-m", "pip", "install", "docx2txt"])
            print("✅ 成功安装 docx2txt")
        
        return True
    except Exception as e:
        print(f"❌ 安装依赖包失败: {e}")
        return False

# 使用python-docx提取文本（主要方法）
def extract_text_with_python_docx(file_path):
    """使用python-docx库提取文本"""
    try:
        from docx import Document
        doc = Document(file_path)
        text_parts = []
        
        for paragraph in doc.paragraphs:
            if paragraph.text.strip():
                # 清理文本中的异常字符
                text = clean_text(paragraph.text)
                if text:
                    text_parts.append(text)
        
        # 如果文档有表格，也提取表格内容
        for table in doc.tables:
            for row in table.rows:
                row_text = []
                for cell in row.cells:
                    if cell.text.strip():
                        clean_cell = clean_text(cell.text)
                        if clean_cell:
                            row_text.append(clean_cell)
                if row_text:
                    text_parts.append("\t".join(row_text))
        
        return "\n\n".join(text_parts)
    except Exception as e:
        print(f"⚠️ 使用python-docx提取失败: {e}")
        return None

# 使用docx2txt提取文本（备用方法）
def extract_text_with_docx2txt(file_path):
    """使用docx2txt库提取文本"""
    try:
        import docx2txt
        text = docx2txt.process(file_path)
        # 清理文本
        return clean_text(text)
    except Exception as e:
        print(f"⚠️ 使用docx2txt提取失败: {e}")
        return None

# 清理文本
def clean_text(text):
    """清理文本中的异常字符和格式，修复编码问题"""
    if not text:
        return ""
    
    # 移除控制字符（除了换行符和制表符）
    text = re.sub(r'[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]', '', text)
    
    # 修复由UTF-8被错误解释为Latin-1导致的乱码
    # 这是QQ浏览器转换格式时常见的问题
    utf8_latin1_mapping = {
        'â€™': "'",
        'â€œ': '"',
        'â€\x9d': '"',
        'â€˜': "'",
        'â€”': '-',
        'â€“': '-',
        'â€¢': '·',
        'Â·': '·',
        'Â§': '§',
        'Â±': '±',
        'Ã—': '×',
        'Ã·': '÷',
        'é»„å¸¦å¥³äºº': '绷带女人',
        'ç»\u008få¸¦å¥³äºº': '绷带女人',
        'æ\u009f¯å¤ªå¤ª': '柯太太',
        'æ\u009f¯å°\u0091ç·': '柯少爷',
        'å¥³ä»\u0086': '女仆',
        'è\u0083¡å\u0095¦ç\u0094·å\u00ad': '胡茬男人',
        'æ´\u008bè£™å¥³å\u00ad': '洋裙女子',
        'é›¾æ\u00993': '雾晓',
        'çº¿ç´¢': '线索',
        'æ\u0089\u008bå\u0086\u008c': '手册',
        'å±žåƒ': '属于',
        'äº‘æµ®é¦\u0086': '云浮馆',
        'æŸ¯è®°çº\u0096å\u008e\u0082': '柯记纱厂',
        'è¥¿å\u008d\u009cå\u008dšå£«': '西卜博士',
        'æ\u0085\u0088æµŽå\u0088\u0098': '慈济堂',
        'è™šå¹´': '虚岁',
        'å\u0087ºç\u0094\u009få¹´': '出生年',
        'åœ¨': '在',
        'ä¸€': '一',
        'ä¸Š': '上',
        'ä¸‹': '下',
        'ä¸­': '中',
        'äºº': '人',
        'æœ‰': '有',
        'å°±': '就',
        'é—ª': '闪',
        'ç«': '火',
        'è½¦': '车',
        'é—´': '间',
        'é—ª': '闪',
        'è¯\u009d': '话',
        'äº‹': '事',
        'è¯´': '说',
        'çœ‹': '看',
        'è¿™': '这',
        'é—¨': '门',
        'å¯': '可',
        'ä»¥': '以',
        'ä¸º': '为',
        'ä¸Ž': '与',
        'çš„': '的',
        'äº†': '了',
        'æ˜¯': '是',
        'æˆ‘': '我',
        'ä»–': '他',
        'å®ƒ': '它',
        'å¹´': '年',
        'ä¸ª': '个',
        'å¦‚': '如',
        'åº”': '应',
        'å¼€': '开',
        'æ‰‹': '手',
        'æŒ‡': '指',
        'å°': '小',
        'å­': '子',
        'è€Œ': '而',
        'è¿›': '进',
        'è¡Œ': '行',
        'å¯¹': '对',
        'å›ž': '回',
        'ä¸¤': '两',
        'é¢': '面',
        'æˆ': '成',
        'æœ¬': '本',
        'ç›¸': '相',
        'ç¬¬': '第',
        'å†™': '写',
        'è¡¨': '表',
        'é—´': '间',
        'åˆ': '又',
        'åŠ': '及',
        'å¾ˆ': '很',
        'ç”Ÿ': '生',
        'å¤§': '大',
        'å†³': '决',
        'ç‰©': '物',
        'å¤©': '天',
        'å·¥': '工',
        'èµ·': '起',
        'å®¶': '家',
        'å‘': '发',
        'çŽ°': '现',
        'ç†': '理',
        'æ–¹': '方',
        'æ³•': '法',
        'å‡º': '出',
        'è§‰': '觉',
        'ç‚¹': '点',
        'ä½œ': '作',
        'å¿ƒ': '心',
        'éƒ½': '都',
        'ç„¶': '然',
        'å½“': '当',
        'æ—¶': '时',
        'é—´': '间',
        'ç”¨': '用',
        'å…¥': '入',
        'ä½\x93': '体',
        'åˆ¶': '制',
        'åŠ¨': '动',
        'åŒ': '同',
        'å·¥': '工',
        'ä¹Ÿ': '也',
        'ç»™': '给',
        'é•¿': '长',
        'æ°´': '水',
        'æ–°': '新',
        'çš„': '的',
        'ç”·': '男',
        'å¥³': '女',
        'é’': '青',
        'å°‘': '少',
        'ç': '着',
        'ç©¿': '穿',
        'æ¡': '条',
        'çº¹': '纹',
        'è¡£': '衣',
        'èƒ¸': '胸',
        'ç»£': '绣',
        'é›¶': '零',
        'å››': '四',
        'åƒ': '像',
        'é—Ž': '问',
        'å—': '吗',
        'è¿˜': '还',
        'æ˜¯': '是',
        'è¿·': '迷',
        'æƒ§': '惑',
        'ä¸Ž': '与',
        'è­¦': '警',
        'æƒ52': '惑',
        'èƒŒ': '背',
        'æ™¯': '景',
        'ç»†': '细',
        'è£': '荣',
        'èº«': '身',
        'ä»½': '份',
        'ç‰¹': '特',
        'å¾?征': '征',
        'æ— ': '无',
        'å¦?å?': '妆',
        'å®¹': '容',
        'é¢': '面',
        'è‚Œ': '肌',
        'è?肤': '肤',
        'æ˜¾': '显',
        'ç™½': '白',
        'è?': '苍',
        'è€?': '老',
        'å£°': '声',
        'éŸ³': '音',
        'æ¸?': '渐',
        'å¼±': '弱',
        'æ': '恐',
        'æƒ§': '惧',
        'å›°': '困',
        'æ?': '惑',
        'è¯¥': '该',
        'å¦‚': '如',
        'ä½•': '何',
        'è§£': '解',
        'è¿™': '这',
        'äº›': '些',
        'é—®': '问',
        'é¢˜': '题',
        'æˆ–': '或',
        'è€…': '者',
        'éœ€': '需',
        'è¦?': '要',
        'å¸®': '帮',
        'åŠ©': '助',
        'æ‰¾': '找',
        'åˆ°': '到',
        'é€š': '通',
        'è·¯': '路',
        'è¿›': '进',
        'å…¥': '入',
        'æˆ¿': '房',
        'é—´': '间',
        'è°ƒ': '调',
        'æŸ¥': '查',
        'çº¿': '线',
        'ç´¢': '索',
        'è®°': '记',
        'å¿†': '忆',
        'ç‰‡': '片',
        'æ–­': '断',
        'ç»­': '续',
        'è¿ž': '连',
        'æŽ¥': '接',
        'å…³': '关',
        'ç³»': '系',
        'å¹³': '平',
        'é¢': '面',
        'åˆ†': '分',
        'å¸ƒ': '布',
        'çŠ¶': '状',
        'æ€': '态',
        'æ— ': '无',
        'ç‰¹': '特',
        'å¾?': '征',
        'æ ‡': '标',
        'æ³¨': '注',
        'åŠŸ': '功',
        'èƒ½': '能',
        'é—¨': '门',
        'çª—': '窗',
        'å®¶': '家',
        'å…·': '具',
        'ä½¿': '使',
        'ç”¨': '用',
        'å†…': '内',
        'éƒ¨': '部',
        'ç»“': '结',
        'æž„': '构',
        'å½¢': '形',
        'çŠ¶': '状',
        'å¤§': '大',
        'å°': '小',
        'é«˜': '高',
        'åº¦': '度',
        'é¢œ': '颜',
        'è‰²': '色',
        'ç°': '灰',
        'é»‘': '黑',
        'çƒ§': '烧',
        'ç—•': '痕',
        'è¿¹': '迹',
        'å®Œ': '完',
        'æ•´': '整',
        'å¢™': '墙',
        'é¢': '面',
        'é—¨': '门',
        'çª—': '窗',
        'è£…': '装',
        'é¥°': '饰',
        'æ®‹': '残',
        'ç•™': '留',
        'åœ°': '地',
        'é¢': '面',
        'å¹³': '平',
        'åŒº': '区',
        'åŸŸ': '域',
        'æ—¶': '时',
        'å…‰': '光',
        'æ˜Ž': '明',
        'æš—': '暗',
        'çƒ›': '烛',
        'çƒ§': '烧',
        'æ—¶': '时',
        'é—´': '间',
        'é•¿': '长',
        'åº¦': '度',
        'æŽ¥': '接',
        'å½“': '当',
        'å‰?': '前',
        'ä¸€': '一',
        'å±‚': '层',
        'äºŒ': '二',
        'å±‚': '层',
        'åœ°': '地',
        'ä¸‹': '下',
        'å®¤': '室',
        'èµ°': '走',
        'é“': '道',
        'è¿›': '进',
        'å…¥': '入',
        'çœ‹': '看',
        'è§‰': '觉',
        'ä¸€': '一',
        'æ ·': '样',
        'åˆ°': '到',
        'ä¸€': '一',
        'ä¸ª': '个',
        'ç‰¹': '特',
        'å¾?': '征',
        'å¼‚': '异',
        'å¸¸': '常',
        'çš„': '的',
        'é¢': '面',
        'å­44': '孔',
        'è¡¨': '表',
        'æƒ…': '情',
        'ç¥ž': '神',
        'æ€?': '态',
        'è¯­': '语',
        'è°ƒ': '调',
        'è¡¥': '补',
        'ä¿¡': '信',
        'æ¯': '息',
        'æ–‡': '文',
        'å­—': '字',
        'å­—': '字',
        'ä½“': '体',
        'æ ¼': '格',
        'å¼?': '式',
        'å•': '单',
        'çº¯': '纯',
        'ä½“': '体',
        'çŽ°': '现',
        'äºº': '人',
        'ç‰©': '物',
        'ä¸»': '主',
        'é¢˜': '题',
        'è¯¥': '该',
        'å¦‚': '如',
        'ä½•': '何',
        'è§£': '解',
        'è¿™': '这',
        'äº›': '些',
        'é—®': '问',
        'é¢˜': '题',
        'æˆ–': '或',
        'è€…': '者',
        'éœ€': '需',
        'è¦?': '要',
        'å¸®': '帮',
        'åŠ©': '助',
        'æ‰¾': '找',
        'åˆ°': '到',
        'é€š': '通',
        'è·¯': '路',
        'è¿›': '进',
        'å…¥': '入',
        'æˆ¿': '房',
        'é—´': '间',
        'è°ƒ': '调',
        'æŸ¥': '查',
        'çº¿': '线',
        'ç´¢': '索',
        'è®°': '记',
        'å¿†': '忆',
        'ç‰‡': '片',
        'æ–­': '断',
        'ç»­': '续',
        'è¿ž': '连',
        'æŽ¥': '接',
        'å…³': '关',
        'ç³»': '系',
        'å¹³': '平',
        'é¢': '面',
        'åˆ†': '分',
        'å¸ƒ': '布',
        'çŠ¶': '状',
        'æ€?': '态',
        'æ— ': '无',
        'ç‰¹': '特',
        'å¾?': '征',
        'æ ‡': '标',
        'æ³¨': '注',
        'åŠŸ': '功',
        'èƒ½': '能',
        'é—¨': '门',
        'çª—': '窗',
        'å®¶': '家',
        'å…·': '具',
        'ä½¿': '使',
        'ç”¨': '用',
        'å†…': '内',
        'éƒ¨': '部',
        'ç»“': '结',
        'æž„': '构',
        'å½¢': '形',
        'çŠ¶': '状',
        'å¤§': '大',
        'å°': '小',
        'é«˜': '高',
        'åº¦': '度',
        'é¢œ': '颜',
        'è‰²': '色',
        'ç°': '灰',
        'é»‘': '黑',
        'çƒ§': '烧',
        'ç—•': '痕',
        'è¿¹': '迹',
        'å®Œ': '完',
        'æ•´': '整',
        'å¢™': '墙',
        'é¢': '面',
        'é—¨': '门',
        'çª—': '窗',
        'è£…': '装',
        'é¥°': '饰',
        'æ®‹': '残',
        'ç•™': '留',
        'åœ°': '地',
        'é¢': '面',
        'å¹³': '平',
        'åŒº': '区',
        'åŸŸ': '域',
        'æ—¶': '时',
        'å…‰': '光',
        'æ˜Ž': '明',
        'æš—': '暗',
        'çƒ›': '烛',
        'çƒ§': '烧',
        'æ—¶': '时',
        'é—´': '间',
        'é•¿': '长',
        'åº¦': '度',
        'æŽ¥': '接',
        'å½“': '当',
        'å‰?': '前',
        'ä¸€': '一',
        'å±‚': '层',
        'äºŒ': '二',
        'å±‚': '层',
        'åœ°': '地',
        'ä¸‹': '下',
        'å®¤': '室',
        'èµ°': '走',
        'é“': '道',
        'è¿›': '进',
        'å…¥': '入',
        'çœ‹': '看',
        'è§‰': '觉',
        'ä¸€': '一',
        'æ ·': '样',
        'åˆ°': '到',
        'ä¸€': '一',
        'ä¸ª': '个',
        'ç‰¹': '特',
        'å¾?': '征',
        'å¼‚': '异',
        'å¸¸': '常',
        'çš„': '的',
        'é¢': '面',
        'å­44': '孔',
        'è¡¨': '表',
        'æƒ…': '情',
        'ç¥ž': '神',
        'æ€?': '态',
        'è¯­': '语',
        'è°ƒ': '调',
        'è¡¥': '补',
        'ä¿¡': '信',
        'æ¯': '息',
        'æ–‡': '文',
        'å­—': '字',
        'å­—': '字',
        'ä½“': '体',
        'æ ¼': '格',
        'å¼?': '式',
        'å•': '单',
        'çº¯': '纯',
        'ä½“': '体',
        'çŽ°': '现',
        'äºº': '人',
        'ç‰©': '物',
        'ä¸»': '主',
        'é¢˜': '题'
    }
    
    # 应用UTF-8/Latin-1乱码修复
    for bad, good in utf8_latin1_mapping.items():
        text = text.replace(bad, good)
    
    # 修复标点符号
    punctuation_fixes = {
        '＂': '"',
        '＂': '"',
        '｀': '`',
        '＇': "'",
        '…．．．': '……',
        '．': '.',
        '，': ',',
        '：': ':',
        '；': ';',
        '？': '?',
        '！': '!',
        '（': '(',
        '）': ')',
        '【': '[',
        '】': ']',
        '％': '%',
        '—': '-',
        '－': '-',
        '～': '~',
        '　': ' ',  # 全角空格
        '--': '——'  # 双破折号替换为标准破折号
    }
    
    for bad, good in punctuation_fixes.items():
        text = text.replace(bad, good)
    
    # 修复特定的乱码词组
    phrase_fixes = {
        # 添加针对当前发现的乱码模式的修复规则
        '闂叆': '进入',
        '灏戝緛': '少爷',
        '绁栧皬': '小厮',
        '寮€绋嬫潵': '看起来',
        '鎯充簡涓€鐐规槸': '觉得一点是',
        '涓€涓€浜�': '一个人',
        '鍙风爜': '号码',
        '鍙峰': '另外',
        '涓嶈兘': '不能',
        '浣犵殑': '你的',
        '鎯充細': '觉得',
        '缁忓巻': '经历',
        '鏃犳剰': '无需',
        '蹇冪悊': '心理',
        '鐪嬪埌': '看到',
        '绋嬪簭': '程序',
        '灏忓緛': '少爷',
        '浣犱滑': '你们',
        '浣犱滑鍙': '你们别',
        '鎯充簡浜嗗埌': '想到了',
        '鐩村埌': '看到',
        '鐪嬬潃': '看着',
        '鐪嬪埌鐨勶紓': '看到的',
        '灏忓緛鐨勶紓': '少爷的',
        '浜轰綋': '身体',
        '鐨勫墠': '的前',
        '涓€浜�': '一个',
        '浜哄彛': '人口',
        '鎯充簡浜嗗埌浜�': '想到了人',
        '浜轰綋鐨勶紓': '身体的',
        '鐪嬪埌鐨勪汉': '看到的人',
        '灏忓緛鐨勪汉': '少爷的人',
        '鐪嬬潃鐨勫緛': '看着的少爷',
        '浜轰綋鐨勫緛': '身体的少爷',
        '鐪嬪埌鐨勫緛': '看到的少爷',
        '灏忓緛鐨勪汉鐨勶紓': '少爷的人的',
        '鐪嬬潃鐨勪汉鐨勶紓': '看着的人的',
        '浜轰綋鐨勪汉鐨勶紓': '身体的人的',
        '鐪嬪埌鐨勪汉鐨勶紓': '看到的人的',
        '灏忓緛鐨勪汉鐨勪汉鐨勶紓': '少爷的人的人的',
        '鐪嬬潃鐨勪汉鐨勪汉鐨勶紓': '看着的人的人的',
        '浜轰綋鐨勪汉鐨勪汉鐨勶紓': '身体的人的人的',
        '鐪嬪埌鐨勪汉鐨勪汉鐨勶紓': '看到的人的人的',
        '闂叆鈥滃ぇ鍘呪€濅竴': '进入“大堂”一',
        '鈥滆儭鑼敺鈥濊繘鏉ュ悗鎺ㄥ紑': '“年轻男子”进来后拉开',
        '鈥滄潅鐗╂埧鈥濈殑闂紝涓€涓敤鎵嬫崅浣忓槾鐨�': '“杂物室”的门，一个用手压低帽檐的',
        '鈥滄磱瑁欏コ瀛愶紓铓濈缉鍦ㄩ噷闈⑩€︹€︿綘鐪嬪埌': '“绷带女人”蜷缩在里面！！！你看到',
        '鈥滆儭鑼敺鈥滆韩绌挎潯绾硅。锛岃兏鍓嶇唬鑻モ€滈浂鍥涒€�,': '“年轻男子”身绑钢丝绳。，嘴前驱说英“零四”，',
        '鍍忔槸鈥滄厛娴庡爞鈥濈殑鐥呬汉锛屼絾鍥犱负鈥滃洓鈥濊皭闊筹紝': '像是“先前楼”的病人，但因为“四”和“死”谐音，',
        '鐥呬汉閮戒富鍔ㄩ伩寮€杩欎釜鍙风爜鈥︹€︾儧鍏変笉鏂憞鏇筹紝姣忎釜浜虹殑闈㈠瓟閮藉洜姝ゆ樉寰楀紓鏍封€︹€�': '病人都主动避开这个编号！！！铃铛不停摇晃，每个人的表情都因此显得恐慌！！！',
        '属千': '属于',
        '讲勿': '请勿',
        '五接': '直接',
        '忤合': '符合',
        '忏是': '皆是',
        '甚础': '基础',
        '寒瞎': '寒暄',
        '洞查': '调查',
        '诮查': '调查',
        '荻得': '获得',
        '具的': '具体的',
        '像': '像',
        '印朵': '印染',
        '西卜博å£«': '西卜博士',
        '西卜博\u008då£«': '西卜博士',
        '云æµ®é¦\u0086': '云浮馆',
        '慈æµŽå\u0088\u0098': '慈济堂',
        '戏过程中请勿直接念剧本．扮演时要符合角色性格': '游戏过程中请勿直接念剧本。扮演时要符合角色性格',
        '注：角色年龄忤是"总岁＂，以"出生年"为1岁．': '注：角色年龄皆是"虚岁"，以"出生年"为1岁。',
        '游戏过程中请勿直接念剧本．扮演时要符合角色性格': '游戏过程中请勿直接念剧本。扮演时要符合角色性格',
        '注：角色年龄皆是"应岁"，以"出生年"为1岁．': '注：角色年龄皆是"虚岁"，以"出生年"为1岁。',
        '游戏过程中诮勿直接念趴本．扮演时要符合角色性格': '游戏过程中请勿直接念剧本。扮演时要符合角色性格',
        '注角色年龄忤是"虔岁"，以"出生年"为1岁': '注：角色年龄皆是"虚岁"，以"出生年"为1岁',
        '游戏过程中讲勿直接念剧本.扮演时要符合角色性格': '游戏过程中请勿直接念剧本。扮演时要符合角色性格',
        '注角色年龄忏是"虚岁"，以"出生年"为1岁': '注：角色年龄皆是"虚岁"，以"出生年"为1岁',
        '注:角色年龄忤是"虔岁"，以"出生年"为1岁': '注：角色年龄皆是"虚岁"，以"出生年"为1岁',
        '注:角色年龄皆是"应岁"，以"出生年"为1岁': '注：角色年龄皆是"虚岁"，以"出生年"为1岁',
        '戏过程中请勿五接念趴本.扮演时要忤合角色性格': '游戏过程中请勿直接念剧本。扮演时要符合角色性格',
        '注:角色年龄皆是"虚岁"，以"出生年"为1岁.': '注：角色年龄皆是"虚岁"，以"出生年"为1岁。',
        '你不能诮查自己的随身物品': '你不能调查自己的随身物品',
        '上七,': '上',
        '月匕......': '',
        'v 顾': '照顾',
        '赛改': '改善',
        '若': '若',
        '素': '素',
        '材': '材',
        '至千': '至于',
        '＾': '',
        '也': '也',
        '蚝缩': '蜷缩',
        '若': '若',
        '绣若': '绣着',
        '分)': '分)',
        '也"': '也"',
        '上七': '上',
        '上\u0007': '上',
        '^^^': '',
        '......': '……',
        '…....': '……',
        '....': '……',
        '^^': '',
        '^': '',
        ' 也': '也',
        '也 ': '也',
        '也"': '也"',
        '":': '"',
        '你不能讽查自己的随身物品': '你不能调查自己的随身物品',
        '你不能溺查自己的随身物品': '你不能调查自己的随身物品',
        '你不能调査自己的随身物品': '你不能调查自己的随身物品'
    }
   # 修复特定的乱码词组 - 增加优先级和应用顺序
    # 先应用长的词组修复，以避免部分匹配导致的错误修复
    sorted_phrases = sorted(phrase_fixes.items(), key=lambda x: len(x[0]), reverse=True)
    for bad, good in sorted_phrases:
        text = text.replace(bad, good)
    
    # 清理多余的空白字符
    text = re.sub(r'\s+', ' ', text).strip()
    text = re.sub(r'\n\s*\n', '\n\n', text)
    
    # 特殊处理：修复一些特殊的乱码模式
    # 处理"???"模式的乱码
    text = re.sub(r'[^\x00-\x7F\u4e00-\u9fff\u3000-\u303f\uff00-\uffef]{1,3}', '', text)
    
    # 额外的乱码修复：处理GBK编码被错误解码的情况
    # 这种乱码通常是由于编码转换错误导致的
    
    return text

# 提取文本（尝试多种方法）
def extract_text_from_docx(file_path):
    """从DOCX文件中提取文本，尝试多种方法"""
    print(f"📄 处理文件: {os.path.basename(file_path)}")
    
    # 优先使用python-docx
    text = extract_text_with_python_docx(file_path)
    if text:
        print(f"✅ 使用python-docx成功提取文本")
        return text
    
    # 如果失败，使用docx2txt作为备选
    text = extract_text_with_docx2txt(file_path)
    if text:
        print(f"✅ 使用docx2txt成功提取文本")
        return text
    
    # 最后尝试直接读取文件（二进制方式）
    try:
        with open(file_path, 'rb') as f:
            binary_data = f.read()
        
        # 尝试多种编码解码
        encodings_to_try = ['utf-8', 'gbk', 'gb2312', 'utf-16']
        for encoding in encodings_to_try:
            try:
                text = binary_data.decode(encoding, errors='replace')
                print(f"⚠️ 使用{encoding}解码（可能有错误）")
                return clean_text(text)
            except:
                continue
        
        print("❌ 所有方法都失败，无法提取文本")
        return ""
    except Exception as e:
        print(f"❌ 读取文件时出错: {e}")
        return ""

# 处理所有DOCX文件
def process_all_docx_files(input_dir):
    """处理指定目录中的所有DOCX文件"""
    if not os.path.exists(input_dir):
        print(f"❌ 目录不存在: {input_dir}")
        return False
    
    output_path = ensure_output_dir()
    
    # 存储找到的文件
    script_files = []
    manual_files = []
    
    # 遍历目录，找出所有的剧本和手册文件
    for filename in os.listdir(input_dir):
        if not filename.lower().endswith('.docx'):
            print(f"⚠️  跳过非DOCX文件: {filename}")
            continue
            
        if filename.startswith('~$'):  # 排除临时文件
            print(f"⚠️  跳过临时文件: {filename}")
            continue
            
        file_path = os.path.join(input_dir, filename)
        if '手册' in filename or '手册' in filename.replace('QQ浏览器转格式', ''):
            manual_files.append((filename, file_path))
        else:
            script_files.append((filename, file_path))
    
    print(f"📋 找到 {len(script_files)} 个剧本文件和 {len(manual_files)} 个手册文件")
    
    # 为当前目录生成唯一的输出文件名
    dir_name = os.path.basename(input_dir)
    # 清理目录名中的特殊字符，用于文件名
    clean_dir_name = re.sub(r'[^a-zA-Z0-9\u4e00-\u9fa5]', '_', dir_name)
    
    # 处理剧本文件
    if script_files:
        script_output = os.path.join(output_path, f"{SCRIPTS_OUTPUT_FILE_PREFIX}{clean_dir_name}.txt")
        print(f"📝 开始写入剧本文件: {script_output}")
        # 使用'w'模式确保每次都是全新写入，不会包含之前的内容
        with open(script_output, 'w', encoding='utf-8') as f:
            # 写入文件头信息
            f.write(f"# 剧本文件合并结果 - {dir_name}\n")
            f.write(f"# 来源目录: {input_dir}\n")
            f.write("# 生成时间: " + datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S") + "\n\n")
            
            for filename, file_path in script_files:
                f.write(f"\n\n===== {filename} =====\n\n")
                print(f"🔍 处理文件: {filename}")
                text = extract_text_from_docx(file_path)
                if text:
                    f.write(text)
                    f.write("\n\n")
                    print(f"✅ 成功写入 {filename} 的内容")
                else:
                    print(f"❌ 无法提取 {filename} 的内容")
        
        # 检查文件大小和内容
        if os.path.exists(script_output):
            file_size = os.path.getsize(script_output)
            print(f"✅ 剧本文件已保存: {script_output} ({file_size:,} 字节)")
    
    # 处理手册文件
    if manual_files:
        manual_output = os.path.join(output_path, f"{MANUALS_OUTPUT_FILE_PREFIX}{clean_dir_name}.txt")
        with open(manual_output, 'w', encoding='utf-8') as f:
            # 写入文件头信息
            f.write(f"# 手册文件合并结果 - {dir_name}\n")
            f.write(f"# 来源目录: {input_dir}\n")
            f.write("# 生成时间: " + datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S") + "\n\n")
            
            for filename, file_path in manual_files:
                f.write(f"\n\n===== {filename} =====\n\n")
                text = extract_text_from_docx(file_path)
                if text:
                    f.write(text)
                    f.write("\n\n")
                else:
                    print(f"❌ 无法提取 {filename} 的内容")
        
        # 检查文件大小和内容
        if os.path.exists(manual_output):
            file_size = os.path.getsize(manual_output)
            print(f"✅ 手册文件已保存: {manual_output} ({file_size:,} 字节)")
    
    return True

# 主函数
def main():
    """主函数"""
    print("🚀 开始处理DOCX文件")
    
    # 安装必要的依赖
    if not install_required_packages():
        print("❌ 无法继续，缺少必要的依赖")
        return 1
    
    # 处理所有目录
    all_success = True
    for input_dir in INPUT_DIRS:
        print(f"\n📂 开始处理目录: {input_dir}")
        if not process_all_docx_files(input_dir):
            all_success = False
    
    if all_success:
        print("\n🎉 所有目录处理完成！")
        return 0
    else:
        print("\n❌ 部分目录处理失败")
        return 1


if __name__ == "__main__":
    sys.exit(main())